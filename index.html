<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Parkplatzbelegung Gewog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f7f7f7; }
    .container {
      max-width: 480px; margin: 0 auto; padding: 1em;
      background: #fff; min-height: 100vh;
      box-sizing: border-box; box-shadow: 0 0 10px rgba(0,0,0,0.05);
      position: relative;
    }

    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em; }
    .header-left { display: flex; align-items: center; }
    .header img { height: 50px; margin-right: 12px; }
    h2 { margin: 0; font-size: 1.4em; }

    label { display: block; margin-top: 1.2em; font-size: 1.1em; }
    input, select, button {
      width: 100%; padding: 0.8em; margin-top: 0.4em;
      font-size: 1.1em; border-radius: 6px;
      border: 1px solid #ccc; box-sizing: border-box;
    }

    button {
      background: #1976d2; color: #fff; border: none;
      font-weight: bold; margin-top: 1.2em;
      cursor: pointer; transition: background 0.2s;
    }
    button:hover { background: #125ea2; }

    .eintragen-btn { background: #3BB54A; }
    .eintragen-btn:hover { background: #2e8b3b; }

    .button-row {
      display: flex; flex-wrap: wrap;
      gap: 0.8em; margin-top: 1.5em;
    }
    .button-row button, .button-row input[type="file"] {
      flex: 1; margin-top: 0;
    }

    .table-responsive { overflow-x: auto; margin-top: 1.5em; }
    table { border-collapse: collapse; width: 100%; min-width: 600px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; font-size: 0.98em; }
    th { background: #f0f0f0; }

    img.thumb {
      width: 60px; height: auto; border-radius: 6px;
      display: block; margin: 0 auto;
    }

    #ocrStatus { font-weight: bold; min-height: 2em; margin-top: .4em; }

    /* Responsive */
    @media (max-width: 600px) {
      .header img { height: 42px; }
      table { min-width: 480px; }
    }
  </style>
</head>

<body>
  <div class="container">

    <div class="header">
      <div class="header-left">
        <img src="https://www.mgs-autozentrum.de/website/themes/mgs-autozentrum.de/img/template_logo.png">
        <h2>Parkplatzbelegung Gewog</h2>
      </div>
    </div>

    <form id="fahrzeugForm" autocomplete="off">

      <label>Fahrgestellnummer (VIN):
        <input type="text" id="vin" placeholder="VIN manuell eingeben oder Google Lens nutzen">
        <div id="ocrStatus"></div>

        <button type="button" id="lensScanBtn" style="background:#673ab7;color:white;">
          VIN mit Google Lens scannen
        </button>

        <button type="button" id="pasteVinBtn" style="background:#009688;color:white;display:none;">
          VIN aus Zwischenablage einf√ºgen
        </button>
      </label>

      <label>Stellplatz:
        <select id="stellplatz"></select>
      </label>

      <label>Status:
        <select id="status">
          <option>Werkstatt</option>
          <option>Bereitstellung Neuwagen</option>
          <option>√úbergabeinspektion</option>
          <option>Lager</option>
          <option>Abholung</option>
          <option>Service</option>
          <option>Leihwagen</option>
          <option>Kundenfahrzeug Lager</option>
        </select>
      </label>

      <label>Fahrzeugfoto (optional):
        <input type="file" id="foto" accept="image/*" capture="environment">
      </label>

      <button type="submit" class="eintragen-btn">Eintragen</button>
    </form>


    <div class="button-row">
      <button onclick="exportHTML()">Export als HTML</button>
      <button onclick="exportExcel()">Export als XLSX</button>
      <button onclick="exportJSON()">Export als JSON</button>

      <button onclick="document.getElementById('jsonImport').click()">JSON importieren</button>
      <input type="file" id="jsonImport" accept=".json" style="display:none">

      <button onclick="clearAllEntries()" style="background:#e53935;">Alle l√∂schen</button>
    </div>

    <div class="table-responsive">
      <table id="datentabelle">
        <thead>
          <tr>
            <th>VIN</th>
            <th>Stellplatz</th>
            <th>Status</th>
            <th>Bild</th>
            <th>L√∂schen</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>
<script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<script>
/* ==========================================================
   INDEXEDDB ‚Äì DATENBANK
   ========================================================== */

let db;

function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open("ParkplatzDB_Gewog", 1);

    request.onupgradeneeded = e => {
      db = e.target.result;
      if (!db.objectStoreNames.contains("fahrzeuge")) {
        db.createObjectStore("fahrzeuge", { keyPath: "id", autoIncrement: true });
      }
    };

    request.onsuccess = e => { db = e.target.result; resolve(); };
    request.onerror = e => reject(e.target.error);
  });
}

function addFahrzeug(data) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction("fahrzeuge", "readwrite");
    const store = tx.objectStore("fahrzeuge");
    store.add(data);
    tx.oncomplete = resolve;
    tx.onerror = e => reject(e.target.error);
  });
}

function getAllFahrzeuge() {
  return new Promise((resolve, reject) => {
    const tx = db.transaction("fahrzeuge", "readonly");
    const store = tx.objectStore("fahrzeuge");
    const req = store.getAll();
    req.onsuccess = () => resolve(req.result);
    req.onerror   = e => reject(e.target.error);
  });
}

function deleteFahrzeug(id) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction("fahrzeuge", "readwrite");
    tx.objectStore("fahrzeuge").delete(id);
    tx.oncomplete = resolve;
    tx.onerror = e => reject(e.target.error);
  });
}

function clearFahrzeuge() {
  return new Promise((resolve, reject) => {
    const tx = db.transaction("fahrzeuge", "readwrite");
    tx.objectStore("fahrzeuge").clear();
    tx.oncomplete = resolve;
    tx.onerror = e => reject(e.target.error);
  });
}


/* ==========================================================
   TABELLENAUFBAU
   ========================================================== */

function clearTable() {
  document.querySelector("#datentabelle tbody").innerHTML = "";
}

function addRowToTable({ id, vin, platz, status, bild }) {
  const tbody = document.querySelector("#datentabelle tbody");
  const tr = document.createElement("tr");

  tr.innerHTML = `
    <td>${vin}</td>
    <td>${platz}</td>
    <td>${status}</td>
    <td>${bild ? `<img class="thumb" src="${bild}">` : ""}</td>
    <td><button onclick="deleteEntry(${id})" style="background:#c62828;color:white;">L√∂schen</button></td>
  `;

  tbody.appendChild(tr);
}

async function loadTable() {
  clearTable();
  const daten = await getAllFahrzeuge();
  daten.forEach(addRowToTable);
}

async function deleteEntry(id) {
  if (!confirm("Diesen Eintrag wirklich l√∂schen?")) return;
  await deleteFahrzeug(id);
  await loadTable();
}


/* ==========================================================
   STELLPLATZ-DROPDOWN (001‚Äì250)
   ========================================================== */

function fillStellplatzDropdown() {
  const sp = document.getElementById("stellplatz");
  sp.innerHTML = "";

  const first = document.createElement("option");
  first.value = "";
  first.textContent = "-- Bitte Stellplatz w√§hlen --";
  sp.appendChild(first);

  for (let i = 1; i <= 250; i++) {
    const txt = i.toString().padStart(3, "0");
    const opt = document.createElement("option");
    opt.value = txt;
    opt.textContent = txt;
    sp.appendChild(opt);
  }
}


/* ==========================================================
   BILD-KONVERTIERUNG (Fotos verkleinern)
   ========================================================== */

function resizeImageToBase64(file, maxDim = 600, quality = 0.75) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    const img = new Image();

    reader.onload = e => {
      img.onload = () => {
        let w = img.width, h = img.height;

        if (w > h && w > maxDim) { h *= maxDim / w; w = maxDim; }
        else if (h > w && h > maxDim) { w *= maxDim / h; h = maxDim; }

        const c = document.createElement("canvas");
        c.width = w; c.height = h;

        const ctx = c.getContext("2d");
        ctx.drawImage(img, 0, 0, w, h);

        resolve(c.toDataURL("image/jpeg", quality));
      };

      img.onerror = reject;
      img.src = e.target.result;
    };

    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}


/* ==========================================================
   FORMULAR ABSENDEN
   ========================================================== */

document.getElementById("fahrzeugForm").onsubmit = async function (e) {
  e.preventDefault();

  const vin = document.getElementById("vin").value.trim();
  const platz = document.getElementById("stellplatz").value;
  const status = document.getElementById("status").value;

  if (!vin) { alert("Bitte VIN eingeben."); return; }
  if (!platz) { alert("Bitte Stellplatz w√§hlen."); return; }

  let bild = "";
  const foto = document.getElementById("foto");

  if (foto.files.length > 0) {
    bild = await resizeImageToBase64(foto.files[0]);
  }

  await addFahrzeug({ vin, platz, status, bild });
  await loadTable();

  this.reset();
  document.getElementById("ocrStatus").textContent = "";
};


/* ==========================================================
   ALLE L√ñSCHEN
   ========================================================== */

async function clearAllEntries() {
  if (!confirm("Alle Eintr√§ge l√∂schen?")) return;
  await clearFahrzeuge();
  clearTable();
}


/* ==========================================================
   EXPORT: JSON
   ========================================================== */

async function exportJSON() {
  const daten = await getAllFahrzeuge();
  const blob = new Blob([JSON.stringify(daten, null, 2)], {
    type: "application/json"
  });
  saveAs(blob, "Parkplatzdaten.json");
}

document.getElementById("jsonImport").addEventListener("change", async function () {
  const file = this.files[0];
  if (!file) return;

  const text = await file.text();
  let arr;

  try {
    arr = JSON.parse(text);
    if (!Array.isArray(arr)) throw "Keine g√ºltige JSON-Liste.";
  } catch (e) {
    alert("Fehler beim JSON-Import: " + e);
    return;
  }

  await clearFahrzeuge();
  for (const item of arr) {
    await addFahrzeug(item);
  }

  await loadTable();
  alert("Import erfolgreich!");
  this.value = "";
});


/* ==========================================================
   EXPORT: HTML
   ========================================================== */

async function exportHTML() {
  const daten = await getAllFahrzeuge();

  let html =
`<!DOCTYPE html>
<html><head><meta charset="UTF-8">
<title>Parkplatzexport</title>
<style>
table{border-collapse:collapse;width:100%;}
td,th{border:1px solid #999;padding:6px;}
img{max-width:120px;}
</style></head><body>
<h2>Parkplatzbelegung</h2>
<table><thead>
<tr><th>VIN</th><th>Stellplatz</th><th>Status</th><th>Bild</th></tr>
</thead><tbody>`;

  daten.forEach(d => {
    html += `
<tr>
  <td>${d.vin}</td>
  <td>${d.platz}</td>
  <td>${d.status}</td>
  <td>${d.bild ? `<img src="${d.bild}">` : ""}</td>
</tr>`;
  });

  html += "</tbody></table></body></html>";

  saveAs(new Blob([html], { type: "text/html" }), "Parkplatzdaten.html");
}


/* ==========================================================
   EXPORT: XLSX
   ========================================================== */

async function exportExcel() {
  const daten = await getAllFahrzeuge();

  const wb = new ExcelJS.Workbook();
  const ws = wb.addWorksheet("Parkpl√§tze");

  ws.columns = [
    { header: "VIN", key: "vin", width: 25 },
    { header: "Stellplatz", key: "platz", width: 12 },
    { header: "Status", key: "status", width: 25 },
    { header: "Bild (Base64)", key: "bild", width: 60 }
  ];

  daten.forEach(d => ws.addRow(d));

  const buf = await wb.xlsx.writeBuffer();
  saveAs(new Blob([buf]), "Parkplatzdaten.xlsx");
}
</script>
<script>
/* ==========================================================
   GOOGLE LENS ‚Äì L√ñSUNG B+ (AUTO-FILL)
   ========================================================== */

/* Pr√ºft ob Android-Ger√§t */
function isAndroid() {
  return /Android/i.test(navigator.userAgent);
}

/* Google Lens starten */
function launchGoogleLens() {
  if (!isAndroid()) {
    alert("Google Lens kann nur auf Android automatisch ge√∂ffnet werden.");
    return;
  }

  // Google Lens Intent √∂ffnen
  window.location.href =
    "intent://com.google.ar.lens#Intent;scheme=googleapp;package=com.google.ar.lens;end";

  // Button einblenden, falls Nutzer manuell einf√ºgen m√∂chte
  document.getElementById("pasteVinBtn").style.display = "block";
}

/* VIN aus Text extrahieren */
function extractVinFromText(text) {
  if (!text) return null;
  const cleaned = text.replace(/[^A-Za-z0-9]/g, "").toUpperCase();
  const match = cleaned.match(/[A-HJ-NPR-Z0-9]{17}/);
  return match ? match[0] : null;
}

/* VIN automatisches Auslesen */
async function tryClipboardVinUpdate(auto = false) {
  try {
    const text = await navigator.clipboard.readText();
    const vin = extractVinFromText(text);

    if (vin) {
      document.getElementById("vin").value = vin;

      document.getElementById("ocrStatus").textContent =
        (auto ? "VIN automatisch √ºbernommen: " : "VIN eingef√ºgt: ") + vin;
      document.getElementById("ocrStatus").style.color = "green";

      // Einf√ºge-Button verbergen
      document.getElementById("pasteVinBtn").style.display = "none";

      return true;
    }
  } catch (e) {}

  return false;
}

/* Manueller Button */
document.getElementById("pasteVinBtn").addEventListener("click", async () => {
  const ok = await tryClipboardVinUpdate(false);
  if (!ok) alert("Keine VIN in der Zwischenablage gefunden.");
});

/* Automatische Erkennung beim Zur√ºckkehren */
document.addEventListener("visibilitychange", async () => {
  if (document.visibilityState === "visible") {

    // Polling: 300 ms * 10 Versuche (3 Sekunden)
    let tries = 0;
    const interval = setInterval(async () => {
      tries++;

      const success = await tryClipboardVinUpdate(true);
      if (success || tries > 10) {
        clearInterval(interval);
      }

    }, 300);
  }
});

/* Button zu Google Lens verbinden */
document.getElementById("lensScanBtn").addEventListener("click", () => {
  document.getElementById("ocrStatus").textContent = "";
  launchGoogleLens();
});
/* ==========================================================
   STELLPLATZ ‚Äì AUTO-VORSCHLAG BEI ERFOLGREICHEM VIN-SCAN
   ========================================================== */

/* Speichert und l√§dt den zuletzt genutzten Stellplatz */
function getLastStellplatz() {
  return localStorage.getItem("lastStellplatz");
}

function setLastStellplatz(value) {
  localStorage.setItem("lastStellplatz", value);
}

/* Gibt den n√§chsten Stellplatz zur√ºck */
function getNextStellplatz() {
  const last = getLastStellplatz();

  if (!last) return ""; // noch nie benutzt

  let n = parseInt(last, 10);
  if (isNaN(n)) return "";

  n = n + 1;
  if (n > 250) n = 1;

  return n.toString().padStart(3, "0");
}

/* √ñffnet das Stellplatz-Dropdown automatisch */
function openStellplatzDropdown() {
  const sp = document.getElementById("stellplatz");

  // Als Touch-Event triggerbar
  const event = new MouseEvent("mousedown", { bubbles: true, cancelable: true });
  sp.dispatchEvent(event);

  // f√ºr Samsung/Chrome fallback
  sp.focus();
}

/* Erweiterung des VIN-Auto√ºbernahme-Prozesses */
async function handleVinAutoFillSuccess() {
  // üîπ Auto-Stellplatz setzen
  const next = getNextStellplatz();
  const sp = document.getElementById("stellplatz");

  if (next) {
    sp.value = next;
  }

  // üîπ Dropdown automatisch √∂ffnen
  openStellplatzDropdown();
}

/* Erweitere tryClipboardVinUpdate() um Stellplatz-Aktion */
const originalTryClipboard = tryClipboardVinUpdate;

tryClipboardVinUpdate = async function (auto = false) {
  const result = await originalTryClipboard(auto);

  if (result) {
    // VIN erfolgreich -> n√§chster Stellplatz & Dropdown √∂ffnen
    handleVinAutoFillSuccess();
  }

  return result;
};

/* Speichere den Stellplatz nach erfolgreichem Eintragen */
document.getElementById("fahrzeugForm").addEventListener("submit", () => {
  const sp = document.getElementById("stellplatz").value;
  if (sp) setLastStellplatz(sp);
});


/* ==========================================================
   INITIALISIERUNG
   ========================================================== */

window.onload = async () => {
  await openDB();
  fillStellplatzDropdown();
  loadTable();
};

</script>

</body>
</html>

