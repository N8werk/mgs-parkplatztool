<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Parkplatzbelegung Gewog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tesseract.js -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.1/dist/tesseract.min.js"></script>

  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f7f7f7; }
    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 1em;
      background: #fff;
      min-height: 100vh;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }

    h2 { margin: 0; font-size: 1.4em; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em; }
    .header img { height: 50px; margin-right: 12px; }

    label { display: block; margin-top: 1.2em; }
    input, select, button {
      width: 100%;
      padding: 0.7em;
      margin-top: 0.3em;
      font-size: 1em;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    button {
      font-weight: bold;
      cursor: pointer;
      background: #1976d2;
      color: #fff;
      border: none;
    }

    .eintragen-btn { background: #3BB54A; }
    .eintragen-btn:hover { background: #2e8a39; }

    .button-row { display: flex; gap: 0.5em; flex-wrap: wrap; margin-top: 1em; }
    .button-row button { flex: 1; }

    #ocrStatus { min-height: 1.7em; font-weight: bold; margin-top: 0.3em; }

    /* LIVE KAMERA */
    #liveOcrSection { display: none; margin-top: 1em; }
    .video-wrapper {
      position: relative;
      width: 100%;
      background: black;
      border-radius: 8px;
      overflow: hidden;
    }

    #vinVideo { width: 100%; display: block; }

    .vin-frame {
      position: absolute;
      border: 2px solid red;
      top: 28%;
      left: 5%;
      width: 90%;
      height: 40%;
      pointer-events: none;
    }
    .vin-frame.detected { border-color: lime; box-shadow: 0 0 10px lime; }

    /* Tabelle */
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 0.4em; }
    th { background: #eee; }

    img.thumb { width: 60px; border-radius: 6px; }

    .delete-btn { background: #e53935 !important; }
  </style>
</head>

<body>
<div class="container">

  <!-- HEADER -->
  <div class="header">
    <div style="display:flex;align-items:center;">
      <img src="https://www.mgs-autozentrum.de/website/themes/mgs-autozentrum.de/img/template_logo.png">
      <h2>Parkplatzbelegung Gewog</h2>
    </div>
    <button id="infoBtn" style="background:none;color:#1976d2;font-size:1.4em;">ℹ️</button>
  </div>

  <!-- FORMULAR -->
  <form id="fahrzeugForm" autocomplete="off">

    <label>Stellplatz:
      <select id="stellplatz">
        <option value="">-- Bitte Stellplatz wählen --</option>
      </select>
    </label>

    <label>Fahrgestellnummer (VIN):
      <input type="text" id="vin" placeholder="VIN manuell oder automatisch" />
      <div id="ocrStatus"></div>
    </label>

    <!-- OCR FOTO -->
    <label>VIN-Foto:
      <input type="file" id="vinFoto" accept="image/*" capture="environment" />
      <button type="button" id="vinOcrBtn">VIN aus Foto erkennen</button>
    </label>

    <!-- LIVE-KAMERA -->
    <button type="button" id="liveOcrToggleBtn">Live VIN-Kamera starten</button>

    <div id="liveOcrSection">
      <p>Zielen Sie die VIN in den roten Rahmen:</p>

      <div class="video-wrapper">
        <video id="vinVideo" autoplay playsinline></video>
        <div class="vin-frame" id="vinFrame"></div>
      </div>

      <!-- NEU: Standbild-Schaltfläche -->
      <button type="button" id="stillFrameBtn"
        style="background:#ff9800;margin-top:0.5em;">
        Standbild analysieren
      </button>
    </div>

    <label>Fahrzeugfoto:
      <input type="file" id="foto" accept="image/*" capture="environment" />
    </label>

    <label>Status:
      <select id="status">
        <option>Werkstatt</option>
        <option>Bereitstellung Neuwagen</option>
        <option>Übergabeinspektion</option>
        <option>Lager</option>
        <option>Abholung</option>
        <option>Service</option>
        <option>Leihwagen</option>
        <option>Kundenfahrzeug Lager</option>
      </select>
    </label>

    <button type="submit" class="eintragen-btn">Eintragen</button>
  </form>

  <!-- BUTTONS -->
  <div class="button-row">
    <button onclick="exportHTML()">HTML Export</button>
    <button onclick="exportExcelWithImages()">XLSX Export</button>
    <button onclick="exportDBasJSON()">JSON Export</button>
    <button onclick="document.getElementById('jsonImport').click()">JSON Import</button>
    <input type="file" id="jsonImport" accept=".json" style="display:none;">
    <button onclick="clearAllEntries()" class="delete-btn">Alle löschen</button>
  </div>

  <!-- SUCHFELD -->
  <input type="text" id="searchInput" placeholder="Suchen...">

  <!-- TABELLE -->
  <table id="datentabelle">
    <thead>
      <tr>
        <th>VIN</th>
        <th>Stellplatz</th>
        <th>Status</th>
        <th>Bild</th>
        <th>Aktion</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

</div>
<!-- Bibliotheken für Export -->
<script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<script>
  let db;
  let ocrEnabled = true;
  let liveOcrActive = false;
  let liveStream = null;
  let liveOcrInterval = null;
  let tesseractBusy = false;

  function setOcrStatus(text, color = "#1976d2") {
    const el = document.getElementById("ocrStatus");
    if (!el) return;
    el.style.color = color;
    el.textContent = text;
  }

  /* ========== IndexedDB ========== */

  function openDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open("ParkplatzDB", 1);
      request.onupgradeneeded = e => {
        db = e.target.result;
        if (!db.objectStoreNames.contains("fahrzeuge")) {
          db.createObjectStore("fahrzeuge", { keyPath: "id", autoIncrement: true });
        }
      };
      request.onsuccess = e => {
        db = e.target.result;
        resolve();
      };
      request.onerror = e => reject(e.target.error);
    });
  }

  function addFahrzeug(data) {
    return new Promise((resolve, reject) => {
      const tx = db.transaction("fahrzeuge", "readwrite");
      tx.objectStore("fahrzeuge").add(data);
      tx.oncomplete = resolve;
      tx.onerror = e => reject(e.target.error);
    });
  }

  function getAllFahrzeuge() {
    return new Promise((resolve, reject) => {
      const tx = db.transaction("fahrzeuge", "readonly");
      const req = tx.objectStore("fahrzeuge").getAll();
      req.onsuccess = () => resolve(req.result || []);
      req.onerror = e => reject(e.target.error);
    });
  }

  function deleteFahrzeug(id) {
    return new Promise((resolve, reject) => {
      const tx = db.transaction("fahrzeuge", "readwrite");
      tx.objectStore("fahrzeuge").delete(id);
      tx.oncomplete = resolve;
      tx.onerror = e => reject(e.target.error);
    });
  }

  function clearFahrzeuge() {
    return new Promise((resolve, reject) => {
      const tx = db.transaction("fahrzeuge", "readwrite");
      tx.objectStore("fahrzeuge").clear();
      tx.oncomplete = resolve;
      tx.onerror = e => reject(e.target.error);
    });
  }

  /* ========== Tabelle & UI ========== */

  function clearTable() {
    const tbody = document.querySelector("#datentabelle tbody");
    if (tbody) tbody.innerHTML = "";
  }

  function addRowToTable({ id, vin, platz, status, bild }) {
    const tbody = document.querySelector("#datentabelle tbody");
    if (!tbody) return;
    const tr = document.createElement("tr");
    tr.dataset.id = id;
    tr.innerHTML = `
      <td>${vin || ""}</td>
      <td>${platz || ""}</td>
      <td>${status || ""}</td>
      <td>${bild ? `<img class="thumb" src="${bild}">` : ""}</td>
      <td><button class="delete-btn" onclick="deleteSingleEntry(${id})">Löschen</button></td>
    `;
    tbody.appendChild(tr);
  }

  async function ladeDaten() {
    clearTable();
    const daten = await getAllFahrzeuge();
    daten.forEach(addRowToTable);
    filterTable();
  }

  async function deleteSingleEntry(id) {
    if (!confirm("Diesen Eintrag wirklich löschen?")) return;
    await deleteFahrzeug(id);
    await ladeDaten();
  }
  window.deleteSingleEntry = deleteSingleEntry;

  async function clearAllEntries() {
    if (!confirm("Wirklich alle Einträge löschen?")) return;
    await clearFahrzeuge();
    await ladeDaten();
  }
  window.clearAllEntries = clearAllEntries;

  function fillStellplatzDropdown() {
    const sel = document.getElementById("stellplatz");
    if (!sel) return;
    sel.innerHTML = '<option value="">-- Bitte Stellplatz wählen --</option>';
    for (let i = 1; i <= 250; i++) {
      const v = i.toString().padStart(3, "0");
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      sel.appendChild(opt);
    }
  }

  function filterTable() {
    const q = (document.getElementById("searchInput")?.value || "").trim().toLowerCase();
    const rows = document.querySelectorAll("#datentabelle tbody tr");
    rows.forEach(r => {
      const txt = r.innerText.toLowerCase();
      r.style.display = txt.includes(q) ? "" : "none";
    });
  }
  document.getElementById("searchInput").addEventListener("input", filterTable);

  /* ========== Bild als Base64 ========== */
  function resizeImageToBase64(file, maxDim = 400, quality = 0.7) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      const reader = new FileReader();
      reader.onload = e => {
        img.onload = () => {
          let w = img.width, h = img.height;
          if (w > maxDim || h > maxDim) {
            if (w > h) { h *= maxDim / w; w = maxDim; }
            else { w *= maxDim / h; h = maxDim; }
          }
          const canvas = document.createElement("canvas");
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, w, h);
          resolve(canvas.toDataURL("image/jpeg", quality));
        };
        img.onerror = reject;
        img.src = e.target.result;
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  /* ========== Export / Import ========== */

  async function exportHTML() {
    const daten = await getAllFahrzeuge();
    let html = "<!DOCTYPE html><html><head><meta charset='UTF-8'><title>Fahrzeugdaten</title>";
    html += "<style>table{border-collapse:collapse;width:100%;}th,td{border:1px solid #ccc;padding:4px;}</style>";
    html += "</head><body><h2>Fahrzeugdaten</h2><table><tr><th>VIN</th><th>Stellplatz</th><th>Status</th></tr>";
    daten.forEach(d => {
      html += `<tr><td>${d.vin || ""}</td><td>${d.platz || ""}</td><td>${d.status || ""}</td></tr>`;
    });
    html += "</table></body></html>";
    saveAs(new Blob([html], {type:"text/html"}), "Fahrzeugdaten.html");
  }
  window.exportHTML = exportHTML;

  async function exportDBasJSON() {
    const daten = await getAllFahrzeuge();
    const blob = new Blob([JSON.stringify(daten, null, 2)], {type:"application/json"});
    saveAs(blob, "Fahrzeugdaten.json");
  }
  window.exportDBasJSON = exportDBasJSON;

  document.getElementById("jsonImport").addEventListener("change", async function() {
    const file = this.files[0];
    if (!file) return;
    try {
      const text = await file.text();
      const arr = JSON.parse(text);
      if (!Array.isArray(arr)) throw new Error("Keine gültige JSON-Liste");
      await clearFahrzeuge();
      for (const item of arr) {
        await addFahrzeug({
          vin: item.vin || "",
          platz: item.platz || "",
          status: item.status || "",
          bild: item.bild || ""
        });
      }
      await ladeDaten();
      alert("JSON-Import erfolgreich.");
    } catch (e) {
      alert("Fehler beim JSON-Import: " + e.message);
    }
    this.value = "";
  });

  async function exportExcelWithImages() {
    const daten = await getAllFahrzeuge();
    const wb = new ExcelJS.Workbook();
    const sheet = wb.addWorksheet("Fahrzeuge");
    sheet.columns = [
      { header: "VIN", key: "vin", width: 20 },
      { header: "Stellplatz", key: "platz", width: 12 },
      { header: "Status", key: "status", width: 25 },
      { header: "Bild(Base64)", key: "bild", width: 50 }
    ];
    daten.forEach(d => {
      sheet.addRow({
        vin: d.vin || "",
        platz: d.platz || "",
        status: d.status || "",
        bild: d.bild || ""
      });
    });
    const buf = await wb.xlsx.writeBuffer();
    saveAs(new Blob([buf]), "Fahrzeugdaten.xlsx");
  }
  window.exportExcelWithImages = exportExcelWithImages;
    /* =============================================================
     ========= Verbesserte VIN-LOGIK & REGEX =========
     ============================================================= */

  function extractVinCandidates(text) {
    if (!text) return [];
    const norm = text.replace(/\s+/g, "").toUpperCase();
    const regex = /[A-HJ-NPR-Z0-9]{17}/g; // kein I, O, Q
    const matches = norm.match(regex) || [];
    // Duplikate entfernen:
    return [...new Set(matches)];
  }

  function handleVinCandidates(candidates) {
    const frame = document.getElementById("vinFrame");
    if (!candidates.length) {
      setOcrStatus("Keine VIN gefunden.", "red");
      frame.classList.remove("detected");
      return;
    }

    const vin = candidates[0];
    document.getElementById("vin").value = vin;
    setOcrStatus("Erkannte VIN: " + vin, "green");

    frame.classList.add("detected");
    setTimeout(() => frame.classList.remove("detected"), 2000);
  }

  /* =============================================================
     ======= Bild-Vorverarbeitung für Tesseract (entscheidend!) =======
     ============================================================= */

  function preprocessCanvasImage(canvas) {
    const ctx = canvas.getContext("2d");
    const { width, height } = canvas;

    const imgData = ctx.getImageData(0, 0, width, height);
    const data = imgData.data;

    // 1. Graustufen
    for (let i = 0; i < data.length; i += 4) {
      const avg = (data[i] + data[i+1] + data[i+2]) / 3;
      data[i] = data[i+1] = data[i+2] = avg;
    }

    // 2. Kontrastverstärkung
    const contrast = 1.35;
    const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
    for (let i = 0; i < data.length; i += 4) {
      data[i]   = factor * (data[i]   - 128) + 128;
      data[i+1] = factor * (data[i+1] - 128) + 128;
      data[i+2] = factor * (data[i+2] - 128) + 128;
    }

    // 3. Schärfen (simpler Kernel)
    // deaktiviert für Performance – kann bei Bedarf aktiviert werden
    // TODO: optional sharpen()

    ctx.putImageData(imgData, 0, 0);
  }

  /* =============================================================
     ======= STANDBILD-OCR (wesentlich besser als Live!) ==========
     ============================================================= */

  async function analyzeStillFrame() {
    if (!liveOcrActive) {
      alert("Die Livekamera muss dafür aktiv sein.");
      return;
    }

    const video = document.getElementById("vinVideo");
    const vw = video.videoWidth;
    const vh = video.videoHeight;

    const canvas = document.createElement("canvas");
    canvas.width = vw;
    canvas.height = vh;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, vw, vh);

   // --- VIN-Streifen exakt croppen (optimiert für dein Foto) ---

// Das VW/VH-Verhältnis deines Beispiels analysiert:
// VIN liegt ca. im unteren Drittel, sehr schmaler horizontaler Streifen

// Wir wählen einen extrem schmalen Bereich, der nur die VIN enthält
const cropX = vw * 0.12;     // etwas Abstand links
const cropW = vw * 0.76;     // verhindert Reflexionsränder

// vertikale Position der VIN exakt aus deinem Bild geschätzt:
const cropY = vh * 0.42;     // leicht unter Mitte
const cropH = vh * 0.10;     // dünner Streifen, exakt wie dein VIN-Foto


    // Vorverarbeitung
    preprocessCanvasImage(cropCanvas);

    setOcrStatus("Standbild wird analysiert …");

    const { data: { text } } = await Tesseract.recognize(
      cropCanvas,
      "eng",
      { tessedit_char_whitelist: "ABCDEFGHJKLMNPRSTUVWXYZ0123456789" }
    );

    const candidates = extractVinCandidates(text);
    handleVinCandidates(candidates);
  }

  document.getElementById("stillFrameBtn").addEventListener("click", analyzeStillFrame);

  /* =============================================================
     ======= FOTO-OCR =============================================
     ============================================================= */

  async function recognizeVinFromImage(imageSource) {
    if (!ocrEnabled) return alert("OCR deaktiviert!");

    setOcrStatus("Foto wird verarbeitet …");

    const img = new Image();
    img.src = URL.createObjectURL(imageSource);

    await img.decode();

    const canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0);

    preprocessCanvasImage(canvas);

    const { data: { text } } = await Tesseract.recognize(
      canvas,
      "eng",
      { tessedit_char_whitelist: "ABCDEFGHJKLMNPRSTUVWXYZ0123456789" }
    );

    const candidates = extractVinCandidates(text);
    handleVinCandidates(candidates);
  }

  document.getElementById("vinOcrBtn").addEventListener("click", async () => {
    const file = document.getElementById("vinFoto").files[0];
    if (!file) return alert("Bitte ein Foto auswählen.");
    await recognizeVinFromImage(file);
  });

  document.getElementById("vinFoto").addEventListener("change", async function() {
    if (!this.files.length) return;
    await recognizeVinFromImage(this.files[0]);
  });

  /* =============================================================
     ======= LIVE-OCR =============================================
     ============================================================= */

  async function startLiveOcr() {
    if (liveOcrActive) return;

    try {
      liveStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" },
        audio: false
      });
    } catch (e) {
      return alert("Kamera konnte nicht gestartet werden: " + e.message);
    }

    const video = document.getElementById("vinVideo");
    video.srcObject = liveStream;

    document.getElementById("liveOcrSection").style.display = "block";
    liveOcrActive = true;
    document.getElementById("liveOcrToggleBtn").textContent = "Live VIN-Kamera stoppen";
    setOcrStatus("Livekamera aktiv.");

    liveOcrInterval = setInterval(async () => {
      if (!ocrEnabled || !liveOcrActive || tesseractBusy) return;

      const vw = video.videoWidth;
      const vh = video.videoHeight;
      if (!vw || !vh) return;

      const canvas = document.createElement("canvas");
      canvas.width = vw;
      canvas.height = vh;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, vw, vh);

      // Zuschneiden wie im Standbild
      const cropX = vw * 0.05;
      const cropY = vh * 0.28;
      const cropW = vw * 0.90;
      const cropH = vh * 0.40;

      const cropCanvas = document.createElement("canvas");
      cropCanvas.width = cropW;
      cropCanvas.height = cropH;
      const cctx = cropCanvas.getContext("2d");
      cctx.drawImage(canvas, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);

      // Vorverarbeiten
      preprocessCanvasImage(cropCanvas);

      tesseractBusy = true;
      const { data: { text } } = await Tesseract.recognize(
        cropCanvas,
        "eng",
        { tessedit_char_whitelist: "ABCDEFGHJKLMNPRSTUVWXYZ0123456789" }
      );
      tesseractBusy = false;

      const candidates = extractVinCandidates(text);
      if (candidates.length) {
        handleVinCandidates(candidates);
      }
    }, 2500);
  }

  function stopLiveOcr() {
    if (!liveOcrActive) return;
    clearInterval(liveOcrInterval);
    liveOcrInterval = null;

    if (liveStream) {
      liveStream.getTracks().forEach(t => t.stop());
      liveStream = null;
    }

    liveOcrActive = false;
    document.getElementById("liveOcrSection").style.display = "none";
    document.getElementById("liveOcrToggleBtn").textContent = "Live VIN-Kamera starten";
    setOcrStatus("Live-OCR gestoppt.");
  }

  document.getElementById("liveOcrToggleBtn").addEventListener("click", () => {
    if (liveOcrActive) stopLiveOcr();
    else startLiveOcr();
  });

  /* =============================================================
     ======= FORMULAR ABSCHLUSS ==================================
     ============================================================= */

  document.getElementById("fahrzeugForm").addEventListener("submit", async function(e) {
    e.preventDefault();

    const platz = document.getElementById("stellplatz").value;
    const vin = document.getElementById("vin").value.trim();
    const status = document.getElementById("status").value;
    const fotoInput = document.getElementById("foto");

    if (!platz) return alert("Bitte Stellplatz auswählen.");

    const alle = await getAllFahrzeuge();
    if (alle.find(d => d.platz === platz)) {
      return alert("Stellplatz " + platz + " ist bereits belegt.");
    }

    let bild = "";
    if (fotoInput.files.length) {
      bild = await resizeImageToBase64(fotoInput.files[0]);
    }

    await addFahrzeug({
      vin,
      platz,
      status,
      bild
    });

    await ladeDaten();
    this.reset();
    stopLiveOcr();
    setOcrStatus("");
  });

  /* =============================================================
     ======= ONLOAD ==============================================
     ============================================================= */

  window.onload = async () => {
    await openDB();
    fillStellplatzDropdown();
    await ladeDaten();
    setOcrStatus("OCR bereit.");
  };

</script>
</body>
</html>


