<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Parkplatzbelegung Gewog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- OCR ES Module – lädt die lokale Version aus deinem GitHub-Repo -->
  <script type="module">
    import * as PaddleOCR from "./ocr/index.esm.js";
    window.PaddleOCR = PaddleOCR;
  </script>

  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f7f7f7; }
    .container { max-width: 480px; margin: 0 auto; padding: 1em; background: #fff; min-height: 100vh; }
    label { display: block; margin-top: 1em; }
    input, select, button { width: 100%; padding: 0.8em; margin-top: 0.4em; }
    button { background: #1976d2; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #125ea2; }
    #ocrStatus { margin-top: 0.5em; font-weight: bold; font-size: 0.9em; color: #1976d2; }
    video { width: 100%; margin-top: 1em; border-radius: 8px; display: none; }
  </style>
</head>

<body>
<div class="container">

  <h2>Parkplatzbelegung Gewog</h2>

  <form id="fahrzeugForm">

    <label>Fahrgestellnummer (VIN):
      <input type="text" id="vin" placeholder="VIN manuell eingeben oder automatisch scannen" />
      <input type="file" id="vinFoto" accept="image/*" capture="environment">
      <button type="button" id="vinOcrBtn">VIN aus Foto erkennen</button>
      <button type="button" id="liveOcrBtn">Live VIN-Kamera starten</button>
      <div id="ocrStatus"></div>
    </label>

    <label>Stellplatz:
      <select id="stellplatz"></select>
    </label>

    <label>Status:
      <select id="status">
        <option>Werkstatt</option>
        <option>Bereitstellung Neuwagen</option>
        <option>Übergabeinspektion</option>
        <option>Lager</option>
        <option>Abholung</option>
        <option>Service</option>
        <option>Leihwagen</option>
        <option>Kundenfahrzeug Lager</option>
      </select>
    </label>

    <label>Fahrzeug Foto:
      <input type="file" id="foto" accept="image/*" capture="environment">
    </label>

    <button type="submit" id="eintragenBtn" style="background:#3BB54A;">Eintragen</button>

  </form>

  <video id="liveVideo" autoplay></video>

</div>

<script>

  /* ──────────────────────────────────────────
   * 1) STELLPLÄTZE LADEN (001–250)
   * ────────────────────────────────────────── */
  function fillStellplatzDropdown() {
    const s = document.getElementById("stellplatz");
    s.innerHTML = '<option value="">-- Bitte Stellplatz wählen --</option>';
    for (let i = 1; i <= 250; i++) {
      const v = i.toString().padStart(3, "0");
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      s.appendChild(opt);
    }
  }

  /* ──────────────────────────────────────────
   * 2) OCR STATUS HELFER
   * ────────────────────────────────────────── */
  function setOcrStatus(msg, color="#1976d2") {
    const el = document.getElementById("ocrStatus");
    el.style.color = color;
    el.textContent = msg;
  }

  /* ──────────────────────────────────────────
   * 3) OCR INITIALISIEREN
   * ────────────────────────────────────────── */
  let ocrReady = false;
  let ocrInitializing = false;
  let ocrEnabled = true;

  async function initOCR() {
    if (ocrReady || ocrInitializing) return;

    ocrInitializing = true;
    setOcrStatus("OCR wird initialisiert, bitte kurz warten...");

    try {
      await window.PaddleOCR.init();     // wichtig!
      ocrReady = true;
      setOcrStatus("OCR bereit.");
    } catch (err) {
      console.error(err);
      setOcrStatus("Fehler beim Laden des OCR Modells: " + err.message, "red");
    } finally {
      ocrInitializing = false;
    }
  }

  /* ──────────────────────────────────────────
   * 4) VIN-KANDIDATEN aus TEXT extrahieren
   *     Gültige VIN = 17 Zeichen, I/O/Q nicht erlaubt
   * ────────────────────────────────────────── */
  function extractVinCandidates(text) {
    const vinRegex = /\b([A-HJ-NPR-Z0-9]{17})\b/g;
    const found = [];
    let m;
    while ((m = vinRegex.exec(text)) !== null) {
      found.push(m[1]);
    }
    return found;
  }

  function handleVinCandidates(candidates) {
    if (!candidates.length) {
      setOcrStatus("Keine VIN gefunden.");
      return;
    }
    document.getElementById("vin").value = candidates[0];
    setOcrStatus("VIN erkannt: " + candidates[0]);
  }

  /* ──────────────────────────────────────────
   * 5) FOTO-OCR
   * ────────────────────────────────────────── */
  document.getElementById("vinOcrBtn").addEventListener("click", async () => {
    await initOCR();
    const input = document.getElementById("vinFoto");
    if (!input.files.length) {
      alert("Bitte ein VIN-Foto auswählen.");
      return;
    }
    const img = await createImageBitmap(input.files[0]);
    const res = await window.PaddleOCR.recognize(img);

    const raw = Array.isArray(res.text) ? res.text.join(" ") : res.text;
    const candidates = extractVinCandidates(raw);
    handleVinCandidates(candidates);
  });

  /* ──────────────────────────────────────────
   * 6) LIVE-KAMERA OCR
   * ────────────────────────────────────────── */
  let streamActive = false;
  const video = document.getElementById("liveVideo");

  document.getElementById("liveOcrBtn").addEventListener("click", async () => {
    await initOCR();

    if (streamActive) {
      video.style.display = "none";
      video.srcObject.getTracks().forEach(t => t.stop());
      streamActive = false;
      setOcrStatus("Livekamera beendet.");
      return;
    }

    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" }
      });
      video.srcObject = stream;
      video.style.display = "block";
      streamActive = true;
      setOcrStatus("Livekamera aktiv. Scanne VIN...");

      startLiveOcrLoop();
    } catch (err) {
      console.error(err);
      alert("Kamera konnte nicht gestartet werden: " + err.message);
    }
  });

  async function startLiveOcrLoop() {
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");

    async function loop() {
      if (!streamActive) return;

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);

      const bitmap = await createImageBitmap(canvas);
      const res = await window.PaddleOCR.recognize(bitmap);

      const raw = Array.isArray(res.text) ? res.text.join(" ") : res.text;
      const candidates = extractVinCandidates(raw);

      if (candidates.length) {
        handleVinCandidates(candidates);
      }

      requestAnimationFrame(loop);
    }

    loop();
  }

  /* ──────────────────────────────────────────
   * 7) FORMULAR SUBMIT
   * ────────────────────────────────────────── */
  document.getElementById("fahrzeugForm").addEventListener("submit", (e) => {
    e.preventDefault();

    const vin = document.getElementById("vin").value.trim();
    if (!vin) { alert("Bitte VIN eingeben oder scannen."); return; }

    alert("Fahrzeug erfolgreich eingetragen:\nVIN: " + vin);
  });

  /* ──────────────────────────────────────────
   * INIT
   * ────────────────────────────────────────── */
  window.onload = async () => {
    fillStellplatzDropdown();
    setOcrStatus("OCR wird initialisiert...");
    await initOCR();
  };

</script>

</body>
</html>
