<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Parkplatzbelegung Gewog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tesseract optional weiterhin geladen -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.1/dist/tesseract.min.js"></script>

  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f7f7f7; }
    .container {
      max-width: 480px; margin: 0 auto; padding: 1em;
      background: #fff; min-height: 100vh;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em; }
    .header img { height: 50px; margin-right: 12px; }
    h2 { margin: 0; }

    label { display: block; margin-top: 1.2em; }
    input, select, button {
      width: 100%; padding: 0.7em; margin-top: 0.3em;
      font-size: 1em; border-radius: 6px; border: 1px solid #ccc;
    }
    button {
      cursor: pointer; font-weight: bold; background: #1976d2; color: #fff; border: none;
    }

    #ocrStatus { min-height: 1.7em; font-weight: bold; margin-top: 0.3em; }

    .button-row { display: flex; flex-wrap: wrap; gap: 0.5em; margin-top: 1em; }
    .button-row button { flex: 1; }

    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 0.4em; }
    th { background: #eee; }

    img.thumb { width: 60px; border-radius: 6px; }
    .delete-btn { background: #e53935 !important; }
  </style>
</head>

<body>
<div class="container">

  <!-- HEADER -->
  <div class="header">
    <div style="display:flex;align-items:center;">
      <img src="https://www.mgs-autozentrum.de/website/themes/mgs-autozentrum.de/img/template_logo.png">
      <h2>Parkplatzbelegung Gewog</h2>
    </div>
  </div>

  <!-- FORMULAR -->
  <form id="fahrzeugForm" autocomplete="off">

    <label>Stellplatz:
      <select id="stellplatz">
        <option value="">-- Bitte Stellplatz wählen --</option>
      </select>
    </label>

    <label>Fahrgestellnummer (VIN):
      <input type="text" id="vin" placeholder="VIN manuell oder automatisch" />
      <div id="ocrStatus"></div>
    </label>

    <!-- GOOGLE LENS -->
    <button type="button" id="lensScanBtn" style="background:#673ab7;">
      VIN mit Google Lens scannen
    </button>

    <button type="button" id="pasteVinBtn" style="background:#009688; display:none;">
      VIN aus Zwischenablage einfügen
    </button>

    <label>VIN-Foto (optional):
      <input type="file" id="vinFoto" accept="image/*" capture="environment" />
    </label>

    <label>Fahrzeugfoto:
      <input type="file" id="foto" accept="image/*" capture="environment" />
    </label>

    <label>Status:
      <select id="status">
        <option>Werkstatt</option>
        <option>Bereitstellung Neuwagen</option>
        <option>Übergabeinspektion</option>
        <option>Lager</option>
        <option>Abholung</option>
        <option>Service</option>
        <option>Leihwagen</option>
        <option>Kundenfahrzeug Lager</option>
      </select>
    </label>

    <button type="submit" class="eintragen-btn" style="background:#3BB54A;margin-top:1em;">
      Eintragen
    </button>

  </form>

  <!-- EXPORT / IMPORT -->
  <div class="button-row">
    <button onclick="exportHTML()">HTML Export</button>
    <button onclick="exportExcelWithImages()">XLSX Export</button>
    <button onclick="exportDBasJSON()">JSON Export</button>
    <button onclick="document.getElementById('jsonImport').click()">JSON Import</button>
    <input type="file" id="jsonImport" accept=".json" style="display:none;">
    <button onclick="clearAllEntries()" class="delete-btn">Alle löschen</button>
  </div>

  <!-- SUCHFELD -->
  <input type="text" id="searchInput" placeholder="Suchen..." style="margin-top:1em;">

  <!-- TABELLE -->
  <table id="datentabelle">
    <thead>
      <tr>
        <th>VIN</th>
        <th>Stellplatz</th>
        <th>Status</th>
        <th>Bild</th>
        <th>Aktion</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

</div>

<!-- EXPORT LIBS -->
<script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>


<script>
/* ================================================================
   IndexedDB
   ================================================================ */

let db;

function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open("ParkplatzDB", 1);

    request.onupgradeneeded = e => {
      db = e.target.result;
      if (!db.objectStoreNames.contains("fahrzeuge")) {
        db.createObjectStore("fahrzeuge", { keyPath: "id", autoIncrement: true });
      }
    };

    request.onsuccess = e => { db = e.target.result; resolve(); };
    request.onerror = e => reject(e.target.error);
  });
}

function addFahrzeug(data) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction("fahrzeuge", "readwrite");
    tx.objectStore("fahrzeuge").add(data);
    tx.oncomplete = resolve;
    tx.onerror = e => reject(e.target.error);
  });
}

function getAllFahrzeuge() {
  return new Promise((resolve, reject) => {
    const tx = db.transaction("fahrzeuge", "readonly");
    const req = tx.objectStore("fahrzeuge").getAll();
    req.onsuccess = () => resolve(req.result || []);
    req.onerror = e => reject(e.target.error);
  });
}

function deleteFahrzeug(id) {
  return new Promise((resolve, reject) => {
    const tx = db.transaction("fahrzeuge", "readwrite");
    tx.objectStore("fahrzeuge").delete(id);
    tx.oncomplete = resolve;
    tx.onerror = e => reject(e.target.error);
  });
}

function clearFahrzeuge() {
  return new Promise((resolve, reject) => {
    const tx = db.transaction("fahrzeuge", "readwrite");
    tx.objectStore("fahrzeuge").clear();
    tx.oncomplete = resolve;
    tx.onerror = e => reject(e.target.error);
  });
}

/* ================================================================
   Tabelle & UI
   ================================================================ */

function clearTable() {
  document.querySelector("#datentabelle tbody").innerHTML = "";
}

function addRowToTable({ id, vin, platz, status, bild }) {
  const tbody = document.querySelector("#datentabelle tbody");
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${vin || ""}</td>
    <td>${platz || ""}</td>
    <td>${status || ""}</td>
    <td>${bild ? `<img class="thumb" src="${bild}">` : ""}</td>
    <td><button class="delete-btn" onclick="deleteSingleEntry(${id})">Löschen</button></td>
  `;
  tbody.appendChild(tr);
}

async function ladeDaten() {
  clearTable();
  const daten = await getAllFahrzeuge();
  daten.forEach(addRowToTable);
  filterTable();
}

async function deleteSingleEntry(id) {
  if (!confirm("Diesen Eintrag löschen?")) return;
  await deleteFahrzeug(id);
  await ladeDaten();
}
window.deleteSingleEntry = deleteSingleEntry;

async function clearAllEntries() {
  if (!confirm("Wirklich alle löschen?")) return;
  await clearFahrzeuge();
  await ladeDaten();
}
window.clearAllEntries = clearAllEntries;

function fillStellplatzDropdown() {
  const sel = document.getElementById("stellplatz");
  sel.innerHTML = '<option value="">-- Bitte Stellplatz wählen --</option>';
  for (let i = 1; i <= 250; i++) {
    const v = i.toString().padStart(3, "0");
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    sel.appendChild(opt);
  }
}

function filterTable() {
  const q = document.getElementById("searchInput").value.toLowerCase();
  const rows = document.querySelectorAll("#datentabelle tbody tr");
  rows.forEach(r => r.style.display = r.innerText.toLowerCase().includes(q) ? "" : "none");
}
document.getElementById("searchInput").addEventListener("input", filterTable);

/* ================================================================
   Bild Base64
   ================================================================ */

function resizeImageToBase64(file, maxDim = 400, quality = 0.7) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    const reader = new FileReader();

    reader.onload = e => {
      img.onload = () => {
        let w = img.width, h = img.height;

        if (w > maxDim || h > maxDim) {
          if (w > h) { h *= maxDim / w; w = maxDim; }
          else { w *= maxDim / h; h = maxDim; }
        }

        const canvas = document.createElement("canvas");
        canvas.width = w; canvas.height = h;
        canvas.getContext("2d").drawImage(img, 0, 0, w, h);

        resolve(canvas.toDataURL("image/jpeg", quality));
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

/* ================================================================
   Google Lens Integration
   ================================================================ */

function isAndroid() {
  return /Android/i.test(navigator.userAgent);
}

function launchGoogleLens() {
  if (!isAndroid()) {
    alert("Google Lens kann nur unter Android direkt gestartet werden.");
    return;
  }

  window.location.href =
    "intent://com.google.ar.lens#Intent;scheme=googleapp;package=com.google.ar.lens;end";

  document.getElementById("pasteVinBtn").style.display = "block";
}

async function pasteVinFromClipboard() {
  try {
    const text = await navigator.clipboard.readText();
    if (!text) return alert("Zwischenablage ist leer.");

    const vin = extractVin(text);
    if (vin) {
      document.getElementById("vin").value = vin;
      document.getElementById("ocrStatus").textContent =
        "VIN übernommen: " + vin;
      document.getElementById("pasteVinBtn").style.display = "none";
    } else {
      alert("Kein VIN-ähnlicher Text in der Zwischenablage.");
    }
  } catch (e) {
    alert("Zwischenablage kann nicht gelesen werden: " + e);
  }
}

function extractVin(text) {
  const cleaned = text.replace(/[^A-Za-z0-9]/g, "").toUpperCase();
  const matches = cleaned.match(/[A-HJ-NPR-Z0-9]{17}/);
  return matches ? matches[0] : null;
}

document.getElementById("lensScanBtn").addEventListener("click", launchGoogleLens);
document.getElementById("pasteVinBtn").addEventListener("click", pasteVinFromClipboard);

// Automatische Erkennung, wenn der Benutzer aus Google Lens zurückkommt
document.addEventListener("visibilitychange", async () => {
  if (document.visibilityState === "visible") {
    try {
      const text = await navigator.clipboard.readText();
      const vin = extractVin(text);
      if (vin) {
        document.getElementById("vin").value = vin;
        document.getElementById("ocrStatus").textContent =
          "VIN automatisch erkannt: " + vin;
        document.getElementById("pasteVinBtn").style.display = "none";
      }
    } catch { }
  }
});

/* ================================================================
   Formular-Submit
   ================================================================ */

document.getElementById("fahrzeugForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  const platz = document.getElementById("stellplatz").value;
  const vin = document.getElementById("vin").value.trim();
  const status = document.getElementById("status").value;
  const fotoInput = document.getElementById("foto");

  if (!platz) return alert("Bitte Stellplatz auswählen.");

  const alle = await getAllFahrzeuge();
  if (alle.find(x => x.platz === platz)) return alert("Stellplatz ist belegt.");

  let bild = "";
  if (fotoInput.files.length) bild = await resizeImageToBase64(fotoInput.files[0]);

  await addFahrzeug({ vin, platz, status, bild });
  await ladeDaten();

  this.reset();
});

/* ================================================================
   Export / Import
   ================================================================ */

async function exportHTML() {
  const daten = await getAllFahrzeuge();

  let html = "<!DOCTYPE html><html><head><meta charset='UTF-8'><title>Fahrzeugdaten</title>";
  html += "<style>table{border-collapse:collapse;width:100%;}th,td{border:1px solid #ccc;padding:4px;}</style>";
  html += "</head><body><h2>Fahrzeugdaten</h2><table><tr><th>VIN</th><th>Stellplatz</th><th>Status</th></tr>";

  daten.forEach(d => {
    html += `<tr><td>${d.vin}</td><td>${d.platz}</td><td>${d.status}</td></tr>`;
  });

  html += "</table></body></html>";
  saveAs(new Blob([html], {type:"text/html"}), "Fahrzeugdaten.html");
}
window.exportHTML = exportHTML;

async function exportDBasJSON() {
  const daten = await getAllFahrzeuge();
  saveAs(
    new Blob([JSON.stringify(daten, null, 2)], { type: "application/json" }),
    "Fahrzeugdaten.json"
  );
}
window.exportDBasJSON = exportDBasJSON;

document.getElementById("jsonImport").addEventListener("change", async function() {
  const file = this.files[0];
  if (!file) return;

  try {
    const arr = JSON.parse(await file.text());
    await clearFahrzeuge();
    for (const item of arr) {
      await addFahrzeug(item);
    }
    await ladeDaten();
    alert("JSON Import erfolgreich.");
  } catch (e) {
    alert("Fehler beim Import: " + e);
  }
  this.value = "";
});

async function exportExcelWithImages() {
  const daten = await getAllFahrzeuge();
  const wb = new ExcelJS.Workbook();
  const sheet = wb.addWorksheet("Fahrzeuge");

  sheet.columns = [
    { header: "VIN", key: "vin", width: 20 },
    { header: "Stellplatz", key: "platz", width: 12 },
    { header: "Status", key: "status", width: 25 },
    { header: "Bild(Base64)", key: "bild", width: 50 }
  ];

  daten.forEach(d => sheet.addRow(d));

  const buf = await wb.xlsx.writeBuffer();
  saveAs(new Blob([buf]), "Fahrzeugdaten.xlsx");
}
window.exportExcelWithImages = exportExcelWithImages;

/* ================================================================
   INIT
   ================================================================ */

window.onload = async () => {
  await openDB();
  fillStellplatzDropdown();
  await ladeDaten();
  document.getElementById("ocrStatus").textContent = "Bereit.";
};

</script>
</body>
</html>
